
---
title: "Beta cells"
date: "2024-5-15" 
date-modified: last-modified
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    warning = FALSE,
    message = FALSE
)
```


```{r }
#| code-fold: true
#| code-summary: "Setup"
suppressPackageStartupMessages({
    library(tidyseurat)
    library(Seurat)
    library(targets)
    library(ggplot2)
    library(ggdist)
    library(ggsignif)
    library(ggpubr)
    library(escape)
})

tar_config_set(store = "/scratch/domeally/DCD.tienhoven_scRNAseq.2024/_targets")
tar_source("/scratch/domeally/DCD.tienhoven_scRNAseq.2024/R")
cpus <- hprcc::slurm_allocation()$CPUs

tar_load(seurat_object_lognorm_annotated)
seurat_object <- load_seurat(seurat_object_lognorm_annotated)

cell_types <- seurat_object |>
    dplyr::select(cell_type) |>
    dplyr::distinct()

cell_type <- "Beta"

seurat_object_beta <- seurat_object |>
    dplyr::filter(diabetes_status == "NODM") |>
    dplyr::filter(cell_type == cell_type)

counts <- as(seurat_object_beta[["RNA"]]$counts, "dgCMatrix")

```

::: {.panel-tabset}

 TODO https://www.borch.dev/uploads/screpertoire/articles/running_escape
 TODO https://davislaboratory.github.io/singscore/
## Beta cells
```{r }
stress_signatures <- signatures[grep("stress", names(signatures), ignore.case = TRUE)]

clean_signature <- function(gene_list) {
    genes <- gene_list[!grepl("-$", gene_list)]
    genes <- gsub("\\+$", "", genes)
}

# Apply the function to each list in stress_signatures
stress_signatures <- lapply(stress_signatures, clean_signature)

enrichment.scores <- escape::escape.matrix(counts,
    gene.sets = stress_signatures,
    method = "UCell",
    groups = 10000,
    min.size = 4,
    BPPARAM = BiocParallel::SnowParam(workers = cpus)
)

```

::::

